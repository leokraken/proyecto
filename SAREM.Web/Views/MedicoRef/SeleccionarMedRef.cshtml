@model SAREM.Web.Models.MedicoReferencia


@{
    ViewBag.Title = "Seleccionar Médico de Referencia";
    Layout = "~/Views/Shared/_User.cshtml";
}

<link rel="stylesheet" href="~/Content/boostrap-table/src/bootstrap-table.css">

@Scripts.Render("~/bundles/jquery")
<script src="~/Scripts/jquery-1.10.2.min.js" type="text/javascript"></script>
<script src="~/Scripts/bootstrap.min.js" type="text/javascript"></script>
<script src="~/Content/boostrap-table/src/bootstrap-table.js"></script>
<script src="~/Content/boostrap-table/src/locale/bootstrap-table-es-ES.js"></script>
@*<script src="~/Content/boostrap-table/src/extensions/filter-control/bootstrap-table-filter-control.js"></script>*@
<script src="~/Content/boostrap-table/src/extensions/mobile/bootstrap-table-mobile.js"></script>

<ol class="breadcrumb">
    <li><a href="#">Médico de Referencia</a></li>
    <li class="active">Seleccionar Médico de Referencia</li>
</ol>

<div class="paragraphs">
    <div class="row">
        <div class="span4">
            <div class="content-heading" style="margin-left:17px !important;">
                <h3 class="pull-left">Seleccionar Médico de Referencia &nbsp &nbsp </h3>
                <img src="~/Content/images/md.png" />
            </div>

        </div>
    </div>
</div>
<br />
<div id="solMR" style="display:none">
    <div id="Busqueda">
        <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
            <div class="panel panel-info">
                <div class="panel-heading" role="tab" id="headingOne">
                    <h4 class="panel-title">
                        <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                            Búsqueda por Especialidad y Médico
                        </a>
                    </h4>
                </div>
                <div id="collapseOne" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="headingOne">
                    <div class="panel-body">
                        <div class="form-horizontal">
                            <div class="form-group">
                                <label class="control-label col-md-2">Especialidad:</label>
                                <div class="col-md-10">
                                    @Html.DropDownListFor(
                        model => model.EspecialidadID,
                        Model.especialidad.Select(l => new SelectListItem
                        {
                            Text = l.descripcion,
                            Value = l.EspecialidadID.ToString()
                        }),
          "Seleccione una Especialidad", new { @class = "especialidad form-control" })
                                    @Html.ValidationMessageFor(model => model.EspecialidadID, "", new { @class = "text-danger" })
                                </div>
                            </div>

                            <div id="medicos" style="display:none">
                                <div class="form-group">
                                    <label class="control-label col-md-2">Médico:</label>
                                    <div class="col-md-10">
                                        @Html.DropDownList("Medico", new SelectList(string.Empty, "Value", "Text"), "Seleccione un Médico", new { @class = "form-control" })
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="control-label col-md-2"></label>
                                <div class="col-md-10">
                                    &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp  &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp  &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp  &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp
                                    <img src="~/Content/images/busqueda.png" style="cursor:pointer;" id="buscar" data-toggle="tooltip" data-placement="bottom" title="Click para buscar" />

                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            <div class="panel panel-info">
                <div class="panel-heading" role="tab" id="headingTwo">
                    <h4 class="panel-title">
                        <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                            Búsqueda por Médico
                        </a>
                    </h4>
                </div>
                <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
                    <div class="panel-body">
                        <div class="form-horizontal">
                            <div class="form-group">
                                <label class="control-label col-md-2">Médico:</label>
                                <div class="col-md-10">
                                    @Html.DropDownList("Medico2", new SelectList(string.Empty, "Value", "Text"), "Seleccione un Médico", new { @class = "form-control" })
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="control-label col-md-2"></label>
                                <div class="col-md-10">
                                    &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp  &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp  &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp  &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp
                                    <img src="~/Content/images/busqueda.png" style="cursor:pointer;" id="buscar2" data-toggle="tooltip" data-placement="bottom" title="Click para buscar" />

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="panel panel-info">
                <div class="panel-heading" role="tab" id="headingThree">
                    <h4 class="panel-title">
                        <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                            Búsqueda por Especialidad
                        </a>
                    </h4>
                </div>
                <div id="collapseThree" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">
                    <div class="panel-body">
                        <div class="form-horizontal">
                            <div class="form-group">
                                <label class="control-label col-md-2">Especialidad:</label>
                                <div class="col-md-10">
                                    @Html.DropDownListFor(
                        model => model.EspecialidadID,
                        Model.especialidad.Select(l => new SelectListItem
                        {
                            Text = l.descripcion,
                            Value = l.EspecialidadID.ToString()
                        }),
          "Seleccione una Especialidad", new { @id= "Especialidad2", @class = "form-control" })
                                    @Html.ValidationMessageFor(model => model.EspecialidadID, "", new { @class = "text-danger" })
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label col-md-2"></label>
                                <div class="col-md-10">
                                    &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp  &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp  &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp  &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp
                                    <img src="~/Content/images/busqueda.png" style="cursor:pointer;" id="buscar3" data-toggle="tooltip" data-placement="bottom" title="Click para buscar" />

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <div id="medReferencia">
        <div>
            <table id="tablaMR" data-search="true" data-mobile-responsive="true" data-check-on-init="true" data-pagination="true" data-side-pagination="client"
                   data-page-list="[10, 25, 50, 100, ALL]" data-row-style="rowStyle"></table>
        </div>
    </div>
</div>
<div id="estadoRef" style="display:none">
 
    <div class="alert alert-info" role="alert"><strong>Recordatorio:</strong> Usted ya ha solicitado un Médico Referente, si desea cambiar de médico elimine la referencia.</div>
    <br />
    <table data-toggle="table" data-url='@Url.Action("GetEstadoReferencias", "MedicoRef")' data-pagination="true" data-side-pagination="client"
           data-page-list="[10, 25, 50, 100, ALL]" data-row-style="rowStyle" id="tabEstado"  data-mobile-responsive="true" data-check-on-init="true">
        <thead>
            <tr>

                <th data-field="MedicoID">Id Médico</th>
                <th data-field="Nombre">Nombre</th>
                <th data-field="Estado">Estado</th>
                <th data-field="fechaSolicitud">Solicitud</th>
                <th data-field="fechaConfirmacion">Confirmación</th>
                <th data-field="operacion" data-events="operateEventsE" data-formatter="operateFormatterE" data-align="center">Eliminar</th>
            </tr>
        </thead>

    </table>
</div>


<script>
    $(document).ready(function () {


        $('[data-toggle="tooltip"]').tooltip();
        //Chequeo si el usuario logueado ya solicito o no médico de referencia
        $.ajax({
            type: 'GET',
            url: '@Url.Action("ChequearSolicitud", "MedicoRef")',
            dataType: 'json',

            cache: false,
            success: function (data) {


                if (data.existe) {
                    $('#tabEstado').bootstrapTable("refresh", { silent: true });
                    $("#estadoRef").show();
                    $("#solMR").hide();

                } else {
                    $("#medicos").css("display", "none");
                    $(".especialidad").prop('selectedIndex', 0);
                    $("#Especialidad2").prop('selectedIndex', 0);
                    $("#Medico2").prop('selectedIndex', 0);
                    $("#collapseOne").collapse('show');
                    $("#estadoRef").hide();
                    $("#solMR").show();
                }
            },
            error: function (ex) {
                //alert('Failed to retrieve states.' + ex);
            }
        });

        //Obtener médicos dada una especialidad

        $(".especialidad").change(function () {
            if ($(".especialidad option:selected").index() != 0) {
                $("#Medico").empty().append('<option value="0">Seleccione un Médico</option>');
                $.ajax({
                    type: 'POST',
                    url: '@Url.Action("GetMedicosEspecialidad", "Consulta")',
                    dataType: 'json',
                    data: { idEspecialidad: $(this).find('option:selected').val() },
                    cache: false,
                    success: function (data) {
                        //Fill div with results
                        // states contains the JSON formatted list
                        // of states passed from the controller

                        $.each(data, function (i, dato) {
                            $("#Medico").append('<option value="' + dato.Value + '">' +
                                 dato.Text + '</option>');
                            // here we are adding option for States

                        });

                        $("#medicos").css("display", "block");
                    },
                    error: function (ex) {
                        alert('Failed to retrieve states.' + ex);
                    }
                });

            }
        });

        $("#buscar").click(function () {

            $('#tablaMR').bootstrapTable('destroy');
            $('#tablaMR').bootstrapTable({
                url: '@Url.Action("GetMedico", "MedicoRef")' + '?idM=' + $("#Medico").find('option:selected').val(),

                columns: [{
                    field: 'MedicoID',
                    title: 'Id Médico'
                }, {
                    field: 'Nombre',
                    title: 'Nombre'
                }, {
                    field: 'operate',
                    title: 'Ver Locales',
                    align: 'center',
                    events: operateEvents,
                    formatter: operateFormatter
                }, {
                    field: 'operateRef',
                    title: 'Referenciar',
                    align: 'center',
                    events: operateEventsRef,
                    formatter: operateFormatterRef
                },

                ]
            });

            $('#medReferencia').show();
        });

        //Por medicos
        $("#buscar2").click(function () {

            $('#tablaMR').bootstrapTable('destroy');
            $('#tablaMR').bootstrapTable({
                url: '@Url.Action("GetMedico", "MedicoRef")' + '?idM=' + $("#Medico").find('option:selected').val(),

                columns: [{
                    field: 'MedicoID',
                    title: 'Id Médico'
                }, {
                    field: 'Nombre',
                    title: 'Nombre'
                }, {
                    field: 'operate',
                    title: 'Ver Locales',
                    align: 'center',
                    events: operateEvents,
                    formatter: operateFormatter
                }, {
                    field: 'operateRef',
                    title: 'Referenciar',
                    align: 'center',
                    events: operateEventsRef,
                    formatter: operateFormatterRef
                },

                ]
            });

            $('#medReferencia').show();
        });
        
        //Por especialidades
        $("#buscar3").click(function () {

            $('#tablaMR').bootstrapTable('destroy');
            $('#tablaMR').bootstrapTable({
                url: '@Url.Action("GetMedico", "MedicoRef")' + '?idM=' + $("#Medico").find('option:selected').val(),

                columns: [{
                    field: 'MedicoID',
                    title: 'Id Médico'
                }, {
                    field: 'Nombre',
                    title: 'Nombre'
                }, {
                    field: 'operate',
                    title: 'Ver Locales',
                    align: 'center',
                    events: operateEvents,
                    formatter: operateFormatter
                }, {
                    field: 'operateRef',
                    title: 'Referenciar',
                    align: 'center',
                    events: operateEventsRef,
                    formatter: operateFormatterRef
                },

                ]
            });

            $('#medReferencia').show();
        });

        function operateFormatterRef(value, row, index) {
            return [

                '<a class="referencia" href="javascript:void(0)" title="Click para Referenciar">',
                '<i class="glyphicon glyphicon-ok"></i>',
                '</a>'
            ].join('');
        }

        function operateFormatter(value, row, index) {
            return [

                '<a class="locales" href="javascript:void(0)" title="Click para ver los locales donde trabaja el Médico">',
                '<i class="glyphicon glyphicon-home"></i>',
                '</a>'
            ].join('');
        }



        window.operateEvents = {

            'click .locales': function (e, value, row, index) {


                $('#tableLocales').bootstrapTable('destroy');
                $('#tableLocales').bootstrapTable({
                    url: '@Url.Action("GetMedicoLocales", "MedicoRef")' + '?idM=' + $("#Medico").find('option:selected').val(),

                    columns: [{
                        field: 'Nombre',
                        title: 'Nombre Local'
                    }, {
                        field: 'Direccion',
                        title: 'Dirección',

                    },

                    ]
                });
                $('#tableLocales').bootstrapTable('resetView');
                $('#modalTable').modal('show');

            }
        }


        window.operateEventsRef = {

            'click .referencia': function (e, value, row, index) {


                $.ajax({
                    url: '@Url.Action("SolicitarReferencia", "MedicoRef")',
                    dataType: "json",
                    type: "POST",
                    data: { idM: row.MedicoID },

                    cache: false,
                    success: function (data) {

                        if (data.success) {

                            $("#solMR").hide();
                            $('#tabEstado').bootstrapTable("refresh", { silent: true });
                            $("#estadoRef").show();


                        } else {

                            alert('error solicitar referencia tipo 2');
                        }
                    },
                    error: function (xhr) {

                        alert('error solicitar referencia tipo 1');
                    }
                })



            }
        }

        $("#cancel").click(function () {


            $.ajax({
                url: '@Url.Action("CancelarReferencia", "MedicoRef")',
                dataType: "json",
                type: "POST",
                data: { idM: $("#idRowCancel").val() },

                cache: false,
                success: function (data) {

                    if (data.success) {

                        $("#solMR").show();
                        $('#tabEstado').bootstrapTable("refresh", { silent: true });
                        $("#estadoRef").hide();
                        $("#medReferencia").hide();
                        $("#medicos").hide();
                        $(".especialidad").prop('selectedIndex', 0);
                        $("#Especialidad2").prop('selectedIndex', 0);
                        $("#Medico2").prop('selectedIndex', 0);
                        $("#collapseOne").collapse('show');

                        $("#modalCancelRef").modal('hide');

                    } else {

                        alert('error cancelar referencia tipo 2');
                    }
                },
                error: function (xhr) {

                    alert('error cancelar referencia tipo 1');
                }
            })

        })
    })

    function rowStyle(row, index) {
        var classes = ['active', 'success', 'info', 'warning', 'danger'];

        if (index % 2 === 0) {
            return {
                classes: classes[2]
            };
        }
        return {};
    }

    function operateFormatterE(value, row, index) {
        return [

            '<a class="eliminar" href="javascript:void(0)" title="Click para eliminar Referencia">',
            '<i class="glyphicon glyphicon-remove"></i>',
            '</a>'
        ].join('');
    }

    window.operateEventsE = {

        'click .eliminar': function (e, value, row, index) {

            $("#idRowCancel").val(row.MedicoID);
            $("#modalCancelRef").modal('show');
        }
    }
</script>

<div class="modal fade" id="modalTable" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title"><span class="alert alert-info"><i class="glyphicon glyphicon-home"></i> Locales Médico</span></h4>
            </div>
            <div class="modal-body">
                <table id="tableLocales"
                       data-toggle="table"
                       data-height="299" data-row-style="rowStyle" data-filter-control="true"></table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<!-- Modal Cancelar Paciente Consulta -->
<div class="modal fade bs-example-modal-sm" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" id="modalCancelRef">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Ok"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">Eliminar Referencia</h4>
            </div>
            <div class="modal-body">
                <p>Está seguro/a que desea eliminar la Referencia ?</p>
                <input id="idRowCancel" type="hidden" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" id="cancel">Si</button>

                <button type="button" class="btn btn-primary" data-dismiss="modal">No</button>
            </div>
        </div>
    </div>
</div>