@model SAREM.Web.Models.Consulta

@{
    ViewBag.Title = "Agendar Consulta";
    Layout = "~/Views/Shared/_User.cshtml";
}

<link rel="stylesheet" href="~/Content/boostrap-table/src/bootstrap-table.css">

@Scripts.Render("~/bundles/jquery")
<script src="~/Scripts/jquery-1.10.2.min.js" type="text/javascript"></script>
<script src="~/Scripts/bootstrap.min.js" type="text/javascript"></script>
<script src="~/Content/boostrap-table/src/bootstrap-table.js"></script>
<script src="~/Content/boostrap-table/src/locale/bootstrap-table-es-ES.js"></script>
@*<script src="~/Content/boostrap-table/src/extensions/filter-control/bootstrap-table-filter-control.js"></script>*@
<script src="~/Content/boostrap-table/src/extensions/mobile/bootstrap-table-mobile.js"></script>

<ol class="breadcrumb">
    <li><a href="#">Consultas</a></li>
    <li class="active">Agendar Consulta</li>
</ol>

<div class="paragraphs">
    <div class="row">
        <div class="span4">
            <div class="content-heading" style="margin-left:17px !important;">
                <h3 class="pull-left">Agendar Consulta &nbsp &nbsp &nbsp </h3>
                <img src="~/Content/images/agenda2.png" />
            </div>

        </div>
    </div>
</div>
<br />
<div>
    <div class="panel panel-info">
        <div class="panel-heading"><button type="button" class="btn btn-info" id="buscar">Buscar  &nbsp &nbsp  <i class="fa fa-search"></i></button> </div>
        <div class="panel-body">
               <div class="form-horizontal">
                  
                       <div class="form-group">
                           <label class="control-label col-md-2">Orígen:</label>
                           <div class="col-md-10">
                               @Html.DropDownListFor(
                        model => model.localID,
                        Model.local.Select(l => new SelectListItem
                        {
                            Text = l.nombre,
                            Value = l.LocalID.ToString()
                        }),
                   "Seleccione un Orígen", new { @class = "origen_change form-control" })
                               @Html.ValidationMessageFor(model => model.localID, "", new { @class = "text-danger" })
                           </div>
                       </div>

                      
                   <div id="especialidades" style="display:none">
                       <div class="form-group">
                           <label class="control-label col-md-2">Especialidad:</label>
                           <div class="col-md-10">

                               @Html.DropDownList("Especial", new SelectList(string.Empty, "Value", "Text"), "Seleccione una Especialidad", new { @class = "form-control" })
                           </div>
                       </div>
                   </div>
                   <div id="medicos" style="display:none">
                       <div class="form-group">
                           <label class="control-label col-md-2">Médico:</label>
                           <div class="col-md-10">
                               @Html.DropDownList("Medico", new SelectList(string.Empty, "Value", "Text"), "Seleccione un Médico", new {  @class = "form-control" })
                           </div>
                       </div>
                   </div>
                   <div class="form-group">
                       <label class="control-label col-md-2">Fecha Consulta:</label>
                       <div class="col-md-10">
                           @Html.EditorFor(model => model.fecha_inicio, new { htmlAttributes = new { @id = "idFI", @class = "form-control datetimepicker", placeholder = "Seleccione una fecha.." } })
                           @Html.ValidationMessageFor(model => model.fecha_inicio, "", new { @class = "text-danger" })
                       </div>
                   </div>
               </div>
        </div>
    </div>

</div>

<div id="divConsultas" style="display:none;">
    <div>
        <table id="tablaConsultas" data-search="true" data-mobile-responsive="true" data-check-on-init="true" data-pagination="true" data-side-pagination="client"
               data-page-list="[10, 25, 50, 100, ALL]" data-row-style="rowStyle"></table>
    </div>
</div> 

<script>
    $(document).ready(function () {


        $(".origen_change").change(function () {

            if ($(".origen_change option:selected").index() != 0) {

                $("#medicos").css("display", "none");
                $("#Especial").empty().append('<option value="0">Seleccione una Especialidad</option>');


                $.ajax({
                    type: 'POST',
                    url: '@Url.Action("GetEspecialidades", "Consulta")',
                    dataType: 'json',
                    data: { idLocalidad: $(this).find('option:selected').val() },
                    cache: false,
                    success: function (data) {
                        //Fill div with results
                        // states contains the JSON formatted list
                        // of states passed from the controller



                        $.each(data, function (i, dato) {
                            $("#Especial").append('<option value="' + dato.Value + '">' +
                                 dato.Text + '</option>');
                            // here we are adding option for States

                        });

                        $("#especialidades").css("display", "block");
                    },
                    error: function (ex) {
                        alert('Failed to retrieve states.' + ex);
                    }
                });
            }
        });

        $("#Especial").change(function () {
            if ($("#Especial option:selected").index() != 0) {
                $("#Medico").empty().append('<option value="0">Seleccione un Médico</option>');
                $.ajax({
                    type: 'POST',
                    url: '@Url.Action("GetMedicos", "Consulta")',
                    dataType: 'json',
                    data: { idEspecialidad: $(this).find('option:selected').val(), idLocalidad: $(".origen_change option:selected").val() },
                    cache: false,
                    success: function (data) {
                        //Fill div with results
                        // states contains the JSON formatted list
                        // of states passed from the controller

                        $.each(data, function (i, dato) {
                            $("#Medico").append('<option value="' + dato.Value + '">' +
                                 dato.Text + '</option>');
                            // here we are adding option for States

                        });

                        $("#medicos").css("display", "block");
                    },
                    error: function (ex) {
                        alert('Failed to retrieve states.' + ex);
                    }
                });

            }
        });


        $("#buscar").click(function () {
            $("#divConsultas").hide();
            if ($(".origen_change option:selected").index() != 0 && $("#Especial option:selected").index() != 0 && $("#Medico option:selected").index() != 0 && $("#idFI").val()) {

                $('#tablaConsultas').bootstrapTable('destroy');
                $('#tablaConsultas').bootstrapTable({
                    url: '@Url.Action("GetConsultasParaAgenda", "Consulta")' + '?idOrigen=' + $(".origen_change").find('option:selected').val() + "&idEspecialidad=" + $("#Especial").find('option:selected').val()
                          + "&idMedico=" + $("#Medico").find('option:selected').val() + "&fechaConsulta=" + $("#idFI").val(),

                    columns: [{
                        field: 'idC',
                        title: 'Id Consulta',
                        visible: false
                    }, {
                        field: 'origen',
                        title: 'Orígen',
                     
                        sortable: true
                    }, {
                        field: 'especialidad',
                        title: 'Especialidad',
                       
                        sortable: true
                    }, {
                        field: 'medico',
                        title: 'Médico',
                       
                        sortable: true
                    }, {
                        field: 'fechaInicio',
                        title: 'Fecha Inicio',
                     
                        sortable: true
                    },
                    {
                        field: 'fechaFin',
                        title: 'Fecha Fin',
                      
                        sortable: true
                    }, {
                        field: 'operate',
                        title: 'Agendar',
                        align: 'center',
                        events: operateEvents,
                        formatter: operateFormatter
                    },

                    ]
                });

                $("#divConsultas").show();
            }

        });

        $("#agendar").click(function () {
            $('#addPacCons').modal('hide');
            $.ajax({
                url: '@Url.Action("AgregarPacienteConsulta", "Consulta")',
                dataType: "json",
                type: "POST",
                data: { idC: $("#idRowAdd").val(), idCT: $("#Turno").find('option:selected').val() },

                cache: false,
                success: function (data) {

                    //if (data.success && data.turno != "LE") {

                    //    $('#pText').text("Se ha agendado correctamente a la consulta, su turno es: " + data.turno + ".")
                    //    $('#modalAlerta').modal('show');



                    //} else if (data.success && data.turno == "LE") {

                    //    $('#pText').text("El cupo de la consulta esta lleno. Ha quedado en Lista de Espera.")
                    //    $('#modalAlerta').modal('show');

                    //} else {

                    //    $('#pText').text("El cupo de la consulta esta lleno y también el de Lista de Espera, por favor busque otra Consulta.")
                    //    $('#modalAlerta').modal('show');
                    //}

                    if (data.success) {
                        $('#tablaConsultas').bootstrapTable('remove', {
                            field: 'idC',
                            values: $("#idRowAdd").val()
                        });

                       $('#pText').text("Se ha agendado correctamente a la consulta, por más información visite la sección Consultas > Ver Consultas Agendadas.");
                       $('#modalAlerta').modal('show');

                    } else {

                        $('#pText').text("Se ha producido un error al agendar la Consulta. Por más información consulte al Administrador de su Centro de Salud.");
                        $('#modalAlerta').modal('show');
                    }
                },
                error: function (xhr) {

                    alert('error agendar consulta tipo 1');
                }
            })

        });

        //Agregar Paciente a Lista de Espera
        $("#agregarListaEspera").click(function () {
         

            $.ajax({
                url: '@Url.Action("AddPacienteConsultaEsperaPaciente", "Consulta")',
                dataType: "json",
                type: "POST",

                data: { idC: $("#idRowConsulta").val() },
                cache: false,
                success: function (data) {

                    if (data.success) {

                        $('#modalAlertaConsulta').modal('hide');
                        $('#tablaConsultas').bootstrapTable('remove', {
                            field: 'idC',
                            values: $("#idRowConsulta").val()
                        });
                        $('#pText').text("Se ha agendado correctamente a la Lista de Espera de la Consulta. Por más información dirijase a la sección Consultas > Ver Consultas Agendadas.");
                        $('#modalAlerta').modal('show');

                    } else {

                        $('#pText').text("Se ha producido un error al realizar la acción. Por más información consulte al Administrador de su Centro de Salud.");
                        $('#modalAlerta').modal('show');
                    }

                },
                error: function (xhr) {

                    alert('error al agregar paciente a lista de espera tipo 1');
                }

            });
        });

        $(function () {
            $('.datetimepicker').datetimepicker({
                locale: 'es',
                format: 'L'

            });

        });

        function operateFormatter(value, row, index) {
            return [

                '<a class="pacientes" href="javascript:void(0)" title="Click para agendar cita en Consulta">',
                '<i class="glyphicon glyphicon-ok"></i>',
                '</a>'
            ].join('');
        }

        window.operateEvents = {

            'click .pacientes': function (e, value, row, index) {
           
                $("#idRowAdd").val(row.idC);
               
                $.ajax({
                    url: '@Url.Action("GetTurnosConsulta", "Consulta")',
                    dataType: "json",
                    type: "GET",

                    data: { idC: row.idC },
                    cache: false,
                    success: function (data) {

                       

                        if (data.hasOwnProperty('turnoVacio')) {

                            //Debo consultar si existe espacio libre en la lista de espera
                            $.ajax({
                                url: '@Url.Action("ConsultarDisponibilidadConsulta", "Consulta")',
                                dataType: "json",
                                type: "GET",
                                data: { idC: row.idC },

                                cache: false,
                                success: function (data) {

                                    if (data.hasOwnProperty('falla')) {

                                        alert('error al consultar disponibilidad consulta tipo 2');

                                    } else {
                                       
                                        if (data.disponibilidadLE) {

                                            $("#idRowConsulta").val(row.idC);
                                            $('#pTextConsulta').text("El cupo de la consulta esta lleno. Desea ingresar a Lista de Espera ?");
                                            $('#modalAlertaConsulta').modal('show');

                                        } else {

                                            $('#pText').text("Los cupos de la Consulta y de la Lista de Espera estan llenos. Por favor, busque otra consulta.");
                                            $('#modalAlerta').modal('show');
                                        }
                                    }
                                },
                                error: function (xhr) {

                                    alert('error al consultar disponibilidad consulta tipo 1');
                                }
                            });

                           
                        } else {

                            $("#Turno").empty().append('<option value="0">Seleccione...</option>');
                            $.each(data, function (i, dato) {
                                $("#Turno").append('<option value="' + dato.Value + '">' +
                                     dato.Text + '</option>');
                                // here we are adding option for States

                            });

                            $('#addPacCons').modal('show');

                        }

                       
                    },
                    error: function (xhr) {

                        alert('error obtener turnos consulta');
                    }
                })



            }
        };
    })

    function rowStyle(row, index) {
        var classes = ['active', 'success', 'info', 'warning', 'danger'];

        if (index % 2 === 0) {
            return {
                classes: classes[2]
            };
        }
        return {};
    }

</script>

<div class="modal fade bs-example-modal-sm" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" id="modalAlerta">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Ok"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">Alerta</h4>
            </div>
            <div class="modal-body">
                <p id="pText"></p>

            </div>
            <div class="modal-footer">


                <button type="button" class="btn btn-primary" data-dismiss="modal">Ok</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade bs-example-modal-sm" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" id="modalAlertaConsulta">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Ok"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">Aviso</h4>
            </div>
            <div class="modal-body">
                <p id="pTextConsulta"></p>
                <input id="idRowConsulta" type="hidden" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="agregarListaEspera">Si</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">No</button>
                
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addPacCons">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">Agendar Consulta</h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal" id="step2">

                    <div class="form-group" id="divTurno">
                        <label for="email" class="col-sm-4 control-label">Turno :</label>
                        <div class="col-sm-8">
                            @Html.DropDownList("Turno", new SelectList(string.Empty, "Value", "Text"), "Seleccione...", new { @style = "width:170px;", @class = "form-control" })
                            <span id="helpTurno" class="help-block" style="display:none"></span>
                        </div>
                    </div>
                    <input id="idRowAdd" type="hidden" />
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>

                <button type="button" class="btn btn-primary" id="agendar">Agendar</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->