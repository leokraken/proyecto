
@{
    ViewBag.Title = "VerConsultasNew";
    Layout = "~/Views/Shared/_Admin.cshtml";
}

<h3>Consultas</h3>

<link rel="stylesheet" href="~/Content/boostrap-table/src/bootstrap-table.css">
<script src="~/Scripts/jquery-1.10.2.min.js" type="text/javascript"></script>
@Scripts.Render("~/bundles/jquery")
<script src="~/Content/boostrap-table/src/bootstrap-table.js"></script>

<script src="~/Content/boostrap-table/src/locale/bootstrap-table-es-ES.js"></script>

<script src="~/Scripts/mustache.js" type="text/javascript"></script>



<script src="~/Content/boostrap-table/src/extensions/filter-control/bootstrap-table-filter-control.js"></script>


    <table data-toggle="table" data-url='@Url.Action("GetConsultas", "Consulta")' data-pagination="true" data-side-pagination="client"
       data-page-list="[10, 25, 50, 100, ALL]" data-row-style="rowStyle" data-sort-order="desc" data-filter-control="true" id="tab" data-id-field ="idC">
    <thead>
        <tr>
            <th data-field="idC" data-visible="false">ID</th>
            <th data-field="origen" data-sortable="true" data-filter-control="input">Orígen</th>
            <th data-field="especialidad" data-sortable="true" data-filter-control="input">Especialidad</th>
            <th data-field="medico" data-sortable="true" data-filter-control="input">Médico</th>
            <th data-field="fechaInicio" data-sortable="true" data-filter-control="input">Fecha Inicio</th>
            <th data-field="fechaFin" data-sortable="true" data-filter-control="input">Fecha Fin</th>
            <th data-field="operacion" data-events="operateEvents" data-formatter="operateFormatter" data-align="center"></th>
        </tr>
    </thead>

</table>
<script>
    $(document).ready(function () {

        $(function () {
            $('.datetimepicker').datetimepicker({
                locale: 'es'

            });

        });

        $("#guardar").click(function () {
            alert("id");
            alert($("#idRow").val());

            $.ajax({
                url: '@Url.Action("Edit", "Consulta")',
                dataType: "json",
                type: "POST",
                contentType: 'application/json; charset=utf-8',
                data: JSON.stringify({
                    consulta: {
                        consultaID: $("#idRow").val(),
                        localID: $("#origen").find('option:selected').val(),
                        especialidadID: $("#esp").find('option:selected').val(),
                        medID: $("#med").find('option:selected').val(),
                        fecha_inicio: $("#fechaInicioM").val(), fecha_fin: $("#fechaFinM").val()
                    }
                }),

                cache: false,
                success: function (data) {

                    if (data.success) {


                        $('#editarCons').modal('hide');



                        $('#tab').bootstrapTable("refresh", { silent: true });







                    } else {

                        alert("error edit");
                    }
                },
                error: function (xhr) {

                    alert('error');
                }
            })


        });

      
       
    });
</script>
<script>

    var $table = $('#table');

    $(document).on('change', '#origen', function () {
        $("#medG").css("display", "none");
        $("#espG").css("display", "none");


        $.ajax({
            type: 'POST',
            url: '@Url.Action("GetEspecialidades", "Consulta")',
            dataType: 'json',
            data: { idLocalidad: $('#origen').find('option:selected').val() },
            cache: false,
            success: function (data) {


                var templateEsp = '<select style="width:280px" id = "esp">{{ #. }}' +
                                  '<option value="{{Value}}">' +
                                   '{{Text}}' +
                                   '</option>' +
                                   '{{ /. }}</select>';



                var html = Mustache.to_html(templateEsp, data);

                $("#especialidadDiv").html(html);
                $("#espG").css("display", "block");
            },
            error: function (ex) {
                alert('Failed to retrieve states.' + ex);
            }
        });
    });

    $(document).on('change', '#esp', function () {

        $("#medG").css("display", "none");



        $.ajax({
            type: 'POST',
            url: '@Url.Action("GetMedicos", "Consulta")',
            dataType: 'json',
            data: { idEspecialidad: $('#esp').find('option:selected').val(), idLocalidad: $('#origen').find('option:selected').val() },
            cache: false,
            success: function (data) {


                var templateMed = '<select style="width:280px" id = "med">{{ #. }}' +
                                  '<option value="{{Value}}">' +
                                   '{{Text}}' +
                                   '</option>' +
                                   '{{ /. }}</select>';



                var html = Mustache.to_html(templateMed, data);

                $("#medicoDiv").html(html);
                $("#medG").css("display", "block");
            },
            error: function (ex) {
                alert('Failed to retrieve states.' + ex);
            }
        });
    });

    function rowStyle(row, index) {
        var classes = ['active', 'success', 'info', 'warning', 'danger'];

        if (index % 2 === 0) {
            return {
                classes: classes[2]
            };
        }
        return {};
    }



    window.operateEvents = {
        'click .like': function (e, value, row, index) {

            $.ajax({
                url: '@Url.Action("Edit", "Consulta")',
                dataType: "json",
                type: "GET",

                data: { idC: row.idC },

                cache: false,
                success: function (data) {

                    $("#idRow").val(row.idC);
                    var template = '<select style="width:280px" id = "origen">{{#locales}}' +
                                   '<option value="{{LocalID}}" {{#sel}}selected{{/sel}}>' +
                                    '{{nombre}}' +
                                    '</option>' +
                                    '{{/locales}}</select>';



                    var html = Mustache.to_html(template, data);


                    $("#origenDiv").html(html);

                    templateEsp = '<select style="width:280px" id = "esp">{{#especialidades}}' +
                                   '<option value="{{EspecialidadID}}" {{#sel}}selected{{/sel}}>' +
                                    '{{descripcion}}' +
                                    '</option>' +
                                    '{{/especialidades}}</select>';



                    html = Mustache.to_html(templateEsp, data);

                    $("#especialidadDiv").html(html);

                    templateMed = '<select style="width:280px" id = "med">{{#medicos}}' +
                                  '<option value="{{FuncionarioID}}" {{#sel}}selected{{/sel}}>' +
                                   '{{nombre}}' +
                                   '</option>' +
                                   '{{/medicos}}</select>';



                    html = Mustache.to_html(templateMed, data);
                    $("#medicoDiv").html(html);

                    $("#fechaInicioM").val(row.fechaInicio);
                    $("#fechaFinM").val(row.fechaFin);

                    $('#editarCons').modal('show');
                },
                error: function (xhr) {

                    alert('error');
                }
            });

           


            //alert('You click like action, row: ' + JSON.stringify(row));

        },
        'click .remove': function (e, value, row, index) {
            alert("aca")
            $table.bootstrapTable('remove', {
                field: 'idC',
                values: [row.idC]
            });
        }
    };

    function operateFormatter(value, row, index) {
        return [
            '<a class="like" href="javascript:void(0)" title="Editar">',
            '<i class="glyphicon glyphicon-pencil"></i>',
            '</a>  ',
            '<a class="remove" href="javascript:void(0)" title="Eliminar">',
            '<i class="glyphicon glyphicon-remove"></i>',
            '</a>'
        ].join('');
    }

    


</script>

<div class="modal fade" id="editarCons">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">Editar Consulta</h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal" id="step2">
                    <div class="form-group">
                        <label for="name" class="col-sm-4 control-label">Orígen :</label>
                        <div class="col-sm-8" id="origenDiv">
                            <!--<input id="name" class="form-control" type="text" placeholder="Enter Your Full Name" /> -->
                        </div>
                    </div>
                    <div id="espG">
                        <div class="form-group">
                            <label for="email" class="col-sm-4 control-label">Especialidad :</label>
                            <div class="col-sm-8" id="especialidadDiv">
                                <!--<input id="email" class="form-control" type="email" placeholder="Enter Your Email-Id" /> -->
                            </div>
                        </div>
                    </div>
                    <div id="medG">
                        <div class="form-group">
                            <label for="email" class="col-sm-4 control-label">Médico :</label>
                            <div class="col-sm-8" id="medicoDiv">
                                <!--<input id="email" class="form-control" type="email" placeholder="Enter Your Email-Id" /> -->
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="email" class="col-sm-4 control-label">Fecha Inicio :</label>
                        <div class="col-sm-8" >
                            <input id="fechaInicioM" class="form-control datetimepicker" placeholder="Seleccione una fecha..." /> 
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="email" class="col-sm-4 control-label">Fecha Fin :</label>
                        <div class="col-sm-8">
                            <input id="fechaFinM" class="form-control datetimepicker" placeholder="Seleccione una fecha..." />
                        </div>
                    </div>
                    <input id="idRow" type="hidden"/>
               </form>
            </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
                         
                            <button type="button" class="btn btn-primary" id="guardar">Guardar Cambios</button>
                        </div>
                    </div><!-- /.modal-content -->
                </div><!-- /.modal-dialog -->
            </div><!-- /.modal -->